<html>

<script src="schedule.js"></script>
<script src="canvasschedule.js"></script>

<div id="scheduleBox" class="box"><div id="sbInner"><canvas id="scheduleCanvas"></div></div>

<div id="geninfo" class="box">
		<textarea id="data"></textarea>
		<table>
			<tr>
				<td></td>
				<td><input type="button" value="generate" onclick="gen();" /></td>
			</tr>
			<tbody id="fields"></tbody>
			<tr>
				<td><input type="button" value="import settings, generate" onclick="importSettings();" /></td>
				<td><input type="button" value="append/replace settings" onclick="appendSettings();" /></td>
			</tr>
		</table>
</div>

<style>
body { display: flex;
       flex-wrap: wrap;
       justify-content: center;
       align-items: center;
       flex-direction: row-reverse }

.box { background-color: #eee; padding: 1em; margin: 1em }

#scheduleBox { display: inline-block }

#geninfo { width:400px }
#data { width: 100%; height: 25em }
#geninfo table { margin: auto }
#geninfo td { padding: 0.2em }
#geninfo td:first-child { text-align: right }
</style>

<script>
let data = document.querySelector("#data");

let srcurl = new URL(window.location.href).searchParams.get("src");

if (srcurl) // sets ui values from text
{
	fetch(srcurl).then((response) => response.text()).then(text => {
		data.value = text
		importSettings()
	})
}

// generate settings panel
for (const [k, v] of Object.entries(default_settings)) {
	
	const field = document.createElement('tr')
	
	field.innerHTML = `<td>${k}</td><td><input id="${k}" type="text" value="${v}" /></td>`
	
	document.querySelector('#fields').appendChild(field)
	
}

gen()

function gen()
{
	let settings = {...default_settings}
	for (let [k, v] of Object.entries(settings)) {
		if (typeof v === 'number') Reflect.set(settings, k, getNumber(k))
		else Reflect.set(settings, k, getString(k))
	}
	
	//settings.shortDays = settings.shortDays.split(",")
	//settings.longDays = settings.longDays.split(",")
	
	s = new ScheduleCanvas('scheduleCanvas', settings)
	
	document.querySelector("#sbInner").style.backgroundColor = s.background
	s.drawSchedule(data.value)
}

function importSettings()
     { for (element of document.getElementById("geninfo").querySelectorAll("input[type=text]"))
              if ((settingValue = getSetting(element.id)) != null)
                     element.value = settingValue
       gen() }

function appendSettings()
     {	let index
       if ((index = data.value.lastIndexOf("\n\nsettings:")) != -1)
              data.value = data.value.substring(0, index)
       data.value += "\n\nsettings:"
       for (element of document.getElementById("geninfo").querySelectorAll("input[type=text]"))
              document.getElementById("data").value += "\n" + element.id + "=" + element.value }

function getLine(start)
     { for (line of data.value.split("\n"))
              if (line.startsWith(start)) return line
       return null }

function getSetting(id)
     {	if ((line = getLine(id + "=")) != null)
              return line.split("=")[1]
       return null }

function getNumber(id) { return Number(getString(id)) }
function getString(id) { return document.getElementById(id).value }
</script>

</html>
