<script src="louscurl.js"></script>
<script src="schedule.js"></script>
<script src="canvasschedule.js"></script>

<div id="scheduleBox" class="box"><div id="sbInner"><canvas id="schedule"></div></div>

<div id="geninfo" class="box">
	<textarea placeholder="enter class codes (e.g. 10038) separated by newlines"id="classesToAdd"></textarea>
	<table>
		<tr><td></td><td><input type="button" value="add classes" onclick="addClasses();" /></td></tr>
		<tr><td><input class="class" id="10038" type="checkbox" onchange="gen();"></input></td><td>10038 elementary arabic ofzo</td></tr>
	</table>
	<textarea placeholder="some output will appear here" id="output"></textarea>
</div>

<style>
body {
	display: flex;
	flex-wrap: wrap;
	justify-content: center;
	align-items: center;
	flex-direction: row-reverse
}

.box { background-color: #eee; padding: 1em; margin: 1em }
	
#sbInner { background-color: #fff; padding: 1em }
#scheduleBox { display: inline-block }

#geninfo { width:400px }
textarea { width: 100%; height: 12em; resize: none }
#geninfo table { margin: auto }
#geninfo td { padding: 0.2em }
#geninfo td:first-child { text-align: right }
</style>

<script>
const CLASS_INPUT = document.querySelector("#classesToAdd")
const SCHEDULE_DISPLAY = new ScheduleCanvas("schedule", {background: "#fff"});

SCHEDULE_DISPLAY.drawSchedule("");

const url = new URL(window.location.href);
const srcurl = url.searchParams.get("src");

// sets ui values from text
if (srcurl) {
	fetch(srcurl)
		.then(resp => resp.text())
		.then(text => {
			CLASS_INPUT.value = text
			addClasses()
		})
}

function addClasses()
{
	for (let c of CLASS_INPUT.value.split('\n'))
		if (c)
			addClass(c, true)
	
	CLASS_INPUT.value = ''
}

function addClass(c, checked)
{
	promiseClass(c, cls => {
		const classSelect = document.createElement('tr')
		
		classSelect.innerHTML = `<td><input class="class" id="${c}" type="checkbox" onchange="gen();"${checked? ' checked':''}></input></td><td>${cls[0].title}</td>`
		
		document.querySelector("#geninfo table").appendChild(classSelect)
		
		gen();
	});
}

function gen()
{
	const classes = Array.from(document.querySelectorAll('.class'))
		.filter(elem => elem.checked)
		.map(elem => elem.id);
	
	promiseSchedule(classes, sched => {
		SCHEDULE_DISPLAY.drawScheduleCallback(sched)
		document.querySelector('#output').value = getTextSchedule(sched)
	});
}

</script>