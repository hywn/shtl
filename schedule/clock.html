<div id="burrito">
	<div id="time">time</div>
	<div id="message">message</div>
</div>

<style>
body { display: flex; justify-content: center; align-items: center; font-size: 2em }
#burrito { width: 12em; padding: 2em }
</style>

<script src="jquery-3.4.1.min.js"></script>
<script src="louscurl.js"></script>
<script src="schedule.js"></script>

<script>

const dows = ['su', 'mo', 'tu', 'we', 'th', 'fr', 'sa'];

let today = new Date()
let curr_dow = today.getDay()

let curr_count = 0, target_count = 1;
let today_items = []

let url = new URL(window.location.href);
let codesurl = url.searchParams.get("src");
let schedurl = url.searchParams.get("schedule");

if (codesurl) { // sets ui values from text
	fetch(codesurl).then(response => response.text()).then(text => {
		promiseSchedule(text.split('\n'), schedule => {
			createClock(schedule);
		})
	})
}

if (schedurl) { // sets ui values from text
	fetch(schedurl).then(response => response.text()).then(text => {
		createClock(parseSchedule(text))
	})
}

function createClock (schedule)
{
	console.log(schedule)
	for (let item of schedule)
		if (item.dows.includes(curr_dow))
			today_items.push(item)
	today_items.sort((a, b) => a.start - b.end)
	setInterval(update, 1000)
}

let time = document.querySelector('#time')
let message = document.querySelector('#message')
let burrito = document.querySelector('#burrito')

const cWARNING = 'ffff6e'
const cOK = '3ce85c'
const cINPROGRESS = 'f5364f'

function update() {

	today = new Date()

	time.innerHTML = `${pad(today.getHours())}:${pad(today.getMinutes())}:${pad(today.getSeconds())}`
	
	let now = today.getHours() + today.getMinutes()/60 + today.getSeconds()/60/60; // hrt
	
	let curr_item = null
	for (let item of today_items)
		if (item.start <= now && now < item.end) {
			curr_item = item; break
		}
	
	let next_item = null
	for (let item of today_items)
		if (item.start > now) {
			next_item = item; break
		}
	
	let last_item = null
	for (let i=today_items.length-1; i>=0; i--)
		if (today_items[i].end < now) {
			last_item = today_items[i]; break
		}
	
	let msg = '';
	
	if (curr_item != null) {
		msg = `you get out in ${Math.round(60 * (curr_item.end - now))} minutes`
		set_gradient (now, curr_item.start, curr_item.end, cINPROGRESS, cOK)
	}
	
	if (next_item != null) {
		let until_hrt = next_item.start - now;
		let hours = Math.floor(until_hrt)
		let minutes = Math.round(60 * (until_hrt - hours))
		msg += `\nyour next item is in ${hours? `${hours} hours and `:''}${minutes} minutes at ${next_item.loc}`
		
		if (curr_item == null) {
			if (until_hrt < 0.25)
				set_gradient (now, next_item.start - 0.25, next_item.start, cWARNING, cINPROGRESS)
			else if (until_hrt < 0.5)
				set_gradient (now, next_item.start - 0.5, next_item.start - 0.25, cOK, cWARNING)
			else
				burrito.style.backgroundColor = '#' + cOK
		}
	}
	
	if(msg === '')
		msg = 'done for the day'
	
	message.innerHTML = msg.trim()
}

function set_gradient(now, start, end, starthex, endhex)
{
	let total = end - start
	let remaining = end - now
	burrito.style.backgroundColor = '#' + get_gradient(1 - remaining/total, starthex, endhex)
}

function get_gradient(percent, start_hex, end_hex)
{
	let startvals = get_three_hex(start_hex)
	let endvals = get_three_hex(end_hex)
	
	let gradient = '';
	
	for (i in startvals)
		gradient += Math.round((startvals[i] + percent * (endvals[i] - startvals[i]))).toString(16)
	
	return gradient
}

function get_three_hex(hexstr) { return hexstr.split(/(?=(?:..)*$)/).map(num => parseInt('0x' + num)) }
function pad (myint) { return myint.toString().padStart(2, '0') }
</script>